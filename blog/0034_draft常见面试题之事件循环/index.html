<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><!-- <link rel="shortcut icon"  href="/favicon.svg" /> --><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" href="/favicon.ico"><link rel="manifest" href="/site.webmanifest"><meta name="generator" content="Astro v4.6.1"><!-- Font preloads --><link rel="preload" href="/fonts/JetBrainsMono-Regular.woff2" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/JetBrainsMono-Bold.woff2" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/JetBrainsMono-Light.woff2" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://hufeispace.com/blog/0034_draft%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B9%8B%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/"><!-- Primary Meta Tags --><title>Draft：常见面试题之事件循环</title><meta name="title" content="Draft：常见面试题之事件循环"><meta name="description" content="这个需要从浏览器和Node.js两方面讲，但是二者的初衷是一致的，但在具体实现原理和事件阶段（宿主环境不同导致）上有些许差异。 首先看下 whatwg 官方给的定义："><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://hufeispace.com/blog/0034_draft%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B9%8B%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/"><meta property="og:title" content="Draft：常见面试题之事件循环"><meta property="og:description" content="这个需要从浏览器和Node.js两方面讲，但是二者的初衷是一致的，但在具体实现原理和事件阶段（宿主环境不同导致）上有些许差异。 首先看下 whatwg 官方给的定义："><meta property="og:image" content="https://hufeispace.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://hufeispace.com/blog/0034_draft%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B9%8B%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/"><meta property="twitter:title" content="Draft：常见面试题之事件循环"><meta property="twitter:description" content="这个需要从浏览器和Node.js两方面讲，但是二者的初衷是一致的，但在具体实现原理和事件阶段（宿主环境不同导致）上有些许差异。 首先看下 whatwg 官方给的定义："><meta property="twitter:image" content="https://hufeispace.com/blog-placeholder-1.jpg"><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%);--bgColor-transparent: #00000000;--bgColor-neutral-muted: #636e7b66}@font-face{font-family:JetBrainsMono;src:url(/fonts/JetBrainsMono-Regular.woff2) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:JetBrainsMono;src:url(/fonts/JetBrainsMono-Light.woff2) format("woff");font-weight:200;font-style:normal;font-display:swap}@font-face{font-family:JetBrainsMono;src:url(/fonts/JetBrainsMono-Bold.woff2) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:JetBrainsMono;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));line-height:1.5}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:2em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a{font-weight:700;text-decoration:none}a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;border-radius:8px}code{padding:.2em .4em;margin:0;font-size:85%;white-space:break-spaces;border-radius:6px;background-color:rgb(var(--gray-light));font-family:JetBrainsMono}pre{padding:.7em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:12px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{margin:0 auto;max-width:980px;display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{grid-area:footer;text-align:center;display:flex;align-items:center;justify-content:center;padding:1.5em}footer[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{font-weight:200;font-size:12px;color:#c8c8c8}footer[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:not(.unset){background-image:none}.gradient-link[data-astro-cid-sz7xmlte]{position:relative;box-decoration-break:clone;text-decoration:none}.gradient-link[data-astro-cid-sz7xmlte]:hover:after{transform:translateZ(0) scale(1)}.gradient-link[data-astro-cid-sz7xmlte]:after{left:0;right:0;bottom:-2px;content:"";height:2px;position:absolute;transform:translateZ(0) scaleX(0);transform-origin:left center;transition:all .15s ease-in-out}
main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:960px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>HuFei&#39;s Site</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> HOME </a>  <a href="/blog" class="active" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> BLOG </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://github.com/hufei365" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>HuFei's GitHub</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo> <img src="https://images.unsplash.com/photo-1710884312730-25dab1810bf9?&w=720&h=360&fit=crop" alt="" data-astro-cid-bvzihdzo> </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2024-03-29T00:00:00.000Z"> 2024年3月29日 </time>  </div> <h1 data-astro-cid-bvzihdzo>Draft：常见面试题之事件循环</h1> <hr data-astro-cid-bvzihdzo> </div>  <h1 id="什么是事件循环event-loop">什么是事件循环Event Loop</h1>
<p>这个需要从浏览器和Node.js两方面讲，但是二者的初衷是一致的，但在具体实现原理和事件阶段（宿主环境不同导致）上有些许差异。</p>
<h2 id="浏览器里的事件循环">浏览器里的事件循环</h2>
<p>首先看下 whatwg 官方给的定义：</p>
<blockquote>
<p>To coordinate events, user interaction, scripts, rendering, networking, and so forth, user agents must use event loops as described in this section. Each agent has an associated event loop, which is unique to that agent.
An event loop has one or more task queues. A task queue is a set of tasks.</p>
</blockquote>
<p><em><strong>为了调度/协调 事件、用户交互、脚本执行、渲染、网络请求等，user agents (一般指浏览器)必须使用官方定义的“事件循环”机制。每个 user agent 都有一个唯一关联的事件循环。</strong></em>
<em><strong>一个事件循环至少有一个任务队列，任务队列就是一组任务的集合。</strong></em></p>
<p>由此可以确定，在浏览器中，事件循环是用来处理用户交互、页面渲染和网络请求等任务的一种方法。</p>
<h3 id="为什么要有这种方法">为什么要有这种方法？</h3>
<p>因为 Javascript 是一种单线程语言，假如遇到耗时较长的任务，最好的方式将这种任务交由其他线程去处理，等处理完有了结果再交回 Javascript 的线程处理。否则，一直占用 JS 的执行线程，有可能造成渲染掉帧、用户操作无响应等问题。比如，在 Javascript 中进行一次网络请求，这件事可以交给“网络”线程去处理。当服务器数据返回到客户端时，这时候将响应数据作为参数传递给回调函数，交由 javascript 的主线程处理。
<img width="1053" alt="NetowrkandTask" src="https://github.com/hufei365/notebook/assets/25574040/78e82bdb-f236-4177-8af9-989dd3a11d0d"></p>
<p>在这个过程中，网络请求实际上变成了异步任务，因为主线程没有同步等待网络请求的返回结果。所以，如果简单来讲的话，浏览器里的事件循环就是用来<strong>调度异步任务的回调函数调用时机</strong>的一种机制（其实 Node.js 类似，只是二者处理的异步任务类型略有不同）。</p>
<h3 id="浏览器的事件循环过程">浏览器的事件循环过程</h3>
<ol>
<li>检查 macrotask 队列是否为空，非空则到 2 ，为空则到 3 ；</li>
<li>执行 macrotask 中的一个任务；</li>
<li>继续检查 microtask 队列是否为空，若有则到 4 ，否则到 5 ；</li>
<li>取出 microtask 中的任务执行，执行完成返回到步骤 3 ；</li>
<li>执行视图更新，假如需要的话；
<img src="https://github.com/hufei365/notebook/assets/25574040/8f12cc10-682f-4571-bb9c-fbf81212674a" alt="Browser-event-loop"></li>
</ol>
<h2 id="nodejs里的事件循环">Node.js里的事件循环</h2>
<p>Node.js 采用 V8 引擎作为 Javascript 的解析引擎，而 I/O 处理方面使用了跨平台的 <code>libuv</code>————一个基于事件驱动的跨平台抽象层，封装了不同操作系统一些底层特性，对外提供统一的 API ，Node.js 的事件循环机制基于 <code>libuv</code> 实现。</p>
<h2 id="宏任务-macro-task-和微任务-micro-job">宏任务 macro task 和微任务 micro job</h2>
<h3 id="常见的宏任务">常见的宏任务：</h3>
<ol>
<li>计时器相关（<code>setTimeout</code>、 <code>setInterval</code>、 <code>setImmediate</code> ）</li>
<li>I/O，例如网络请求、用户交互事件</li>
<li><code>MessageChannel</code></li>
<li><code>postMessage</code></li>
<li>UI rendering</li>
</ol>
<h3 id="常见的微任务">常见的微任务</h3>
<ol>
<li>Promsie</li>
<li>MutationObserver</li>
<li>queueMicrotask</li>
<li>process.nextTcik（node.js only)</li>
</ol>
<h2 id="总结一下">总结一下</h2>
<ol>
<li>js是单线程的，但是浏览器&#x26;Node.js不是单线程的；</li>
<li>事件循环是用来处理异步任务回调函数调用时机的一种机制，目的是为了保证程序流畅高效地运行，最大限度利用计算资源；
<ol>
<li>在浏览器中，最重要的是能及时响应用户交互行为；</li>
<li>在Node.js中，最重要的是能提高CPU的利用率，高效的响应外部请求；</li>
</ol>
</li>
</ol>  </div> </article> </main> <footer class="text-sm leading-[1.75] mt-4" data-astro-cid-sz7xmlte> <div data-astro-cid-sz7xmlte> <span data-astro-cid-sz7xmlte> <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" class="text-slate-400 text-xs" data-astro-cid-sz7xmlte>署名-非商业性使用 4.0 国际许可协议<br data-astro-cid-sz7xmlte>
转载请保留原文链接及作者</a> </span> </div> </footer>  </body></html>